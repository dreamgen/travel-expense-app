# 旅遊記帳 App 優化技術方案

## 一、 資料庫結構變更 (Google Sheets)

為了支援多團、多權限，需調整 Sheet 結構。

### 分頁 Trips (新增)
| 欄位 | 說明 | 範例 |
| :--- | :--- | :--- |
| **A欄 (TripCode)** | 唯一識別碼 | `2024-JP-Spring` |
| **B欄 (Password)** | 團長管理密碼 | `********` |
| **C欄 (Leader)** | 團長名稱 | `Alex` |
| **D欄 (Members)** | 團員清單 (字串, 逗號分隔) | `Alice,Bob,Charlie` |
| **E欄 (Status)** | 狀態 | `Active`, `Locked`, `Archived` |

### 分頁 Expenses (修改)
*   **新增欄位 TripCode**：用於區分不同團的帳務。
*   **新增欄位 BelongTo**：消費歸屬人，預設同填表人，團長可修改。

---

## 二、 Google Apps Script (GAS) 邏輯變更

### 1. 內嵌管理後台 (針對第 9 點)

在 `Code.gs` 新增以下函式，讓審核人員直接在 Sheet 操作：

```javascript
function onOpen() {
  SpreadsheetApp.getUi()
      .createMenu('旅遊記帳管理')
      .addItem('開啟審核後台', 'showAdminSidebar')
      .addToUi();
}

function showAdminSidebar() {
  // 重用現有的 admin/index.html，但在 Sheet 環境下渲染
  var html = HtmlService.createTemplateFromFile('admin_index').evaluate()
      .setTitle('單據審核系統')
      .setWidth(400); // Sidebar 寬度
  SpreadsheetApp.getUi().showSidebar(html);
}
```

### 2. API 權限驗證 (針對第 1, 2, 5, 7 點)

修改 `doPost` 或 API 路由，增加 `action` 參數判斷：

*   `action: 'login_auditor'`: 驗證系統屬性中的密碼 -> 回傳 Token (Auditor)。
*   `action: 'login_leader'`: 驗證 Trips 表中的密碼 -> 回傳 Token (Leader, 包含 TripCode)。
*   `action: 'get_expenses'`:
    *   若 Token 是 **Auditor**: 回傳所有資料。
    *   若 Token 是 **Leader**: 只回傳該 TripCode 資料。
    *   若無 Token (**Member**): 需傳入 `TripCode` + `MemberName`，只回傳匹配的資料。

---

## 三、 前端 App 邏輯變更 (Client Side)

### 1. 團員與同步 (針對第 3, 4 點)

*   **Login UI**: 輸入 `TripCode` 後，執行 `fetchMembers(tripCode)`。
*   **顯示 Dropdown**: `[團長: Alex, Alice, Bob, ... + 新增成員]`。
*   **儲存**: 選擇後儲存 `currentUser = { name: 'Alice', tripCode: 'JP01' }` 到 localStorage。
*   **View Filter**: 在渲染列表時：

```javascript
const myExpenses = allExpenses.filter(item => 
  item.submitter === currentUser.name || item.belongTo === currentUser.name
);
renderList(myExpenses);
```

### 2. 圖片檢視器 (針對第 7 點)

在 `admin.js` 引入簡易 Lightbox：

```javascript
function showImageModal(imageUrl) {
  // 建立一個覆蓋全螢幕的 div
  // 內部 img 支援 wheel event 修改 transform: scale(z)
}
```

---

## 四、 部署自動化 (針對第 6 點)

建議將 `config.json` 的內容改由 GAS 動態注入。
若將前端 HTML 也放入 GAS (作為 Web App 輸出)，則可以在 `HtmlTemplate` 中直接寫：

```html
<script>
  const CONFIG = {
    apiUrl: "<?= ScriptApp.getService().getUrl() ?>"
  };
</script>
```

這樣網址永遠是正確的。