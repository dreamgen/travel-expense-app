# 員工旅遊費用申請系統 - 需求說明書 (PRD)

| 項目 | 內容 |
| :--- | :--- |
| **版本** | 1.3.0 |
| **整理日期** | 2026-01-30 |
| **適用範圍** | 前端 PWA 應用程式、後端 Google Apps Script、審核管理後台 |

---

## 1. 專案概述 (Overview)

### 1.1 產品目標
開發一款支援離線使用、跨平台的 **漸進式網頁應用程式 (PWA)**，協助員工在旅遊期間即時記錄費用、拍攝單據。系統採用「**去中心化記帳、中心化整併**」的模式，員工可隨時將資料備份至雲端或進行跨裝置同步，最終由團長/主辦人統整所有團員資料，一鍵產生標準格式 Excel 申請單進行送審。

### 1.2 適用對象
*   **一般員工**：使用手機 APP 記錄費用、拍照、上傳雲端備份、查詢審核狀態、進行補件修改。
*   **團長/主辦人**：發起旅遊並產生 `TripCode`，匯入或同步團員費用進行合併，管理旅遊結案鎖定狀態，最終列印 Excel 申請單。
*   **財務/人資/管理者**：使用管理後台審核費用、查看單據照片、發送補件通知（預通知信）、管理補助發放。

---

## 2. 系統架構 (System Architecture)

### 2.1 前端 (Client App)
*   **技術棧**：原生 JavaScript (ES6+), Tailwind CSS, HTML5。
*   **儲存**：瀏覽器 `LocalStorage` (本地持久化)、`IndexedDB` (圖片儲存)。
*   **功能庫**：`SheetJS` (Excel 處理)、`FileReader API` (圖片讀取)。
*   **部署**：靜態網頁託管 (GitHub Pages, Netlify, Vercel)。

### 2.2 後端與資料庫 (Cloud Backend)
*   **平台**：Google Apps Script (GAS)。
*   **資料庫**：Google Sheets (試算表) 作為資料存儲 (Trips, Expenses, Employees)。
*   **檔案存儲**：Google Drive (儲存單據照片)。
*   **通知服務**：Gmail App (發送審核預通知信)。

### 2.3 管理後台 (Admin Dashboard)
*   **介面**：基於 Web 的 SPA (Single Page Application)。
*   **通訊**：透過 `doPost` 與 GAS API 進行 JSON 資料交換。

---

## 3. 功能需求 (Functional Requirements)

### 3.1 前端 APP (員工端)

#### 3.1.1 旅遊設定 (Trip Settings)
*   **基本資訊**：設定旅遊地點、出發/結束日期。
*   **TripCode 機制**：
    *   **團長**：建立旅遊後產生唯一 `TripCode` (如 `TRP-20250201-ABCD`) 並分享給團員。
    *   **團員**：輸入 `TripCode` 以加入該旅遊群組，確保資料可被整併。
*   **補助參數**：設定每人補助額度上限、匯款方式、補助方式。

#### 3.1.2 費用記錄 (Expense Tracking)
*   **新增費用**：支援代收轉付、住宿、交通、餐費等類別，具備多幣別自動匯率換算。
*   **單據拍照**：
    *   **離線支援**：在無網路環境下（如飛機上）仍可正常拍照並儲存於 `IndexedDB`。
    *   **圖片壓縮**：自動壓縮圖片以優化傳輸。

#### 3.1.3 雲端同步與跨裝置 (Cloud Sync & Cross-Device)
*   **上傳/備份**：
    *   **同名檢核 (Duplicate Check)**：
        *   當裝置首次對該 `TripCode` 執行上傳時，系統需檢查雲端是否已有相同「提交人姓名」的資料。
        *   **若存在同名**，系統回傳該同名資料的「上次提交時間」，並彈出提示：「偵測到同名資料（上次更新：YYYY/MM/DD HH:mm），請問這是您之前的備份嗎？」
        *   **選項 A (是本人/覆蓋)**：確認覆蓋，繼續上傳。
        *   **選項 B (非本人/改名)**：要求使用者修改提交人姓名（例如加上部門或暱稱），避免誤蓋他人資料。
    *   **版本/時間戳記檢核 (Timestamp Check)**：
        *   前端記錄每次修改的 `localLastModified` 時間。
        *   上傳時，後端比對雲端資料的 `serverLastModified`。
        *   **若 server > local**：拒絕寫入，提示使用者：「雲端已有較新版本，請先執行『下載同步』以免資料遺失。」
    *   **鎖定檢查**：若該 `TripCode` 已被團長「結案鎖定」，則禁止上傳並提示聯絡團長解鎖。

*   **下載/同步**：
    *   **情境**：更換裝置（如從手機換到電腦）繼續編輯。
    *   **操作**：輸入 `TripCode` + 提交人姓名，從雲端拉取最新的費用與照片資料至本地。

*   **JSON 備份**：保留手動匯入/匯出 JSON 功能，作為純離線環境下的物理備份手段。

#### 3.1.4 統計與匯出 (Statistics & Export)
*   **即時儀表板**：顯示個人費用總計與預估補助金額。
*   **Excel 申請單 (送簽用)**：
    *   由團長在完成資料整併與送審鎖定後執行。
    *   **格式要求**：產生包含完整合併後的團員資料、費用明細、統計金額與正式簽核欄位的 Excel 電子檔。
    *   **用途**：供列印成紙本，進行公司內部的實體簽呈流程。

### 3.2 後端 API (Google Apps Script)

#### 3.2.1 資料處理
*   **申請接收 (`submitTrip`)**：
    *   **鎖定檢核**：首先檢查 **Trips** 表中該 `tripCode` 的 `isLocked` 狀態。若為 `true`，直接回傳錯誤「案件已鎖定」。
    *   **同名/版本檢核**：
        *   接收 Payload 中的 `submittedBy` 與 `lastModified`。
        *   比對資料庫中該使用者的最後更新時間。
        *   執行上述前端定義的檢核邏輯（同名警示或版本衝突拒絕）。
    *   **資料寫入**：若檢核通過，刪除舊有 **Expenses** 記錄，寫入新資料，並更新 `serverLastModified` 時間戳記。

#### 3.2.2 通知機制
*   **審核通知 (`sendReviewNotification`)**：
    *   **觸發時機**：當後台審核狀態變更為「需補件 (Needs Revision)」或「退回 (Rejected)」時。
    *   **行為**：系統自動寄送一封「預通知信」給審核人員 (Admin)。
    *   **內容**：包含 `TripCode`、申請人、被退回/補件的項目與備註。
    *   **目的**：供審核人員確認內容後，自行轉寄或修改內容通知申請員工（人工通知流程）。

### 3.3 管理後台 (Admin Dashboard)

#### 3.3.1 審核流程
*   **列表與篩選**：依 `TripCode` 或狀態篩選申請單。
*   **逐筆審核**：
    *   對每筆費用標記「通過」、「退回」或「補件」。
    *   填寫審核備註（如：單據模糊、金額不符）。
*   **狀態推導**：系統依據明細狀態自動更新整筆申請單狀態。

#### 3.3.2 旅遊管理 (Trip Management)
*   **結案鎖定 (Locking)**：
    *   團長/管理者可將特定 `TripCode` 狀態設為 「**已鎖定 (Locked)**」。
    *   鎖定後，所有團員無法再上傳或修改雲端資料，確保送簽資料一致性。
*   **解鎖補正 (Unlocking)**：
    *   若需補件或修正，團長可手動 「**解鎖 (Unlock)**」。
    *   解鎖後，團員即可再次上傳更新資料。

---

## 4. 使用案例流程 (User Flows)

### 4.1 流程 A：一般記帳與備份 (員工)
1.  **取得代碼**：從團長處取得 `TripCode`。
2.  **日常記帳**：在 APP 中輸入 `TripCode`，離線/連線記錄費用並拍照。
3.  **雲端備份 (首次)**：
    *   點擊「上傳至雲端」。
    *   **系統檢查**：雲端是否有同名資料？
        *   **情境 1 (無同名)**：直接上傳成功。
        *   **情境 2 (有同名)**：系統提示「發現同名資料（上次更新：10/20 14:00），是否改名？」。
        *   使用者選擇「改名」-> 輸入新名字 -> 上傳。
4.  **雲端備份 (後續)**：
    *   點擊「上傳至雲端」。
    *   **系統檢查**：本地時間戳記是否 >= 雲端時間戳記？
        *   **通過**：覆蓋更新。
        *   **衝突**：提示先下載同步。

### 4.2 流程 B：團長整併與送件 (團長)
1.  **發起旅遊**：設定行程，產生 `TripCode` 並發送給所有團員。
2.  **收集資料**：確認團員皆已上傳。
3.  **鎖定案件**：在後台/管理介面點擊 「**鎖定 Trip**」，防止團員誤改資料。
4.  **產生送簽文件**：
    *   在 APP 中檢視整併後的最終資料。
    *   點擊 「**匯出 Excel**」 下載正式申請單電子檔。
5.  **列印送簽**：將 Excel 檔列印，附上紙本單據，進行公司內部簽核。

### 4.3 流程 C：跨裝置作業 (員工)
1.  **手機端**：旅遊時使用手機記錄並拍照 -> 點擊「上傳至雲端」。
2.  **電腦端**：
    *   輸入 `TripCode` + 姓名 -> 點擊「同步/下載」。
    *   編輯資料（補充說明）。
    *   點擊「上傳至雲端」。
    *   **系統檢查**：確認電腦端資料版本新於雲端版本 -> 允許覆蓋。

### 4.4 流程 D：審核與補件 (審核人員 & 員工)
1.  **後台審核**：審核人員標記某單據「需補件」。
2.  **系統通知**：GAS 發信通知審核人員。
3.  **人工轉知**：審核人員通知員工補件。
4.  **員工補件**：
    *   員工發現無法上傳（因為案件已鎖定）。
    *   通知團長/審核人員要求解鎖。
5.  **解鎖與更新**：
    *   團長執行 「**解鎖**」。
    *   員工 APP 修改照片後重新上傳。
    *   團長確認無誤後再次 「**鎖定**」。

---

## 5. 資料結構 (Data Structure)

### 5.1 Trips (旅遊主檔)

| 欄位名稱 | 說明 |
| :--- | :--- |
| `tripCode` | 唯一識別碼 (PK) |
| `location` | 旅遊地點 |
| `startDate` | 開始日期 |
| `endDate` | 結束日期 |
| `subsidyAmount` | 補助額度 |
| `status` | 狀態 (`pending`, `approved`, `rejected`, `needs_revision`) |
| `submittedBy` | 提交人 |
| `isLocked` | 是否鎖定 (`TRUE`/`FALSE`) |

### 5.2 Expenses (費用明細)

| 欄位名稱 | 說明 |
| :--- | :--- |
| `expenseId` | 費用唯一碼 |
| `tripCode` | 關聯旅遊代碼 (FK) |
| `category` | 類別 |
| `amount` | 原幣金額 |
| `currency` | 幣別 |
| `exchangeRate`| 匯率 |
| `amountNTD` | 台幣金額 |
| `photoUrl` | Google Drive 圖片連結 |
| `expenseStatus` | 單筆審核狀態 |
| `reviewNote` | 審核備註 |
| `lastModified` | 最後修改時間戳記 |

---

## 6. 非功能需求 (Non-Functional Requirements)

### 6.1 使用者體驗 (UX)
*   **離線優先**：拍照與記帳功能必須在飛航模式下完全可用。
*   **網路提示**：執行「上傳/下載」時若偵測無網路，應跳出友善提示。

### 6.2 安全性 (Security)
*   **傳輸安全**：強制 HTTPS。
*   **資料權限**：覆蓋資料時需嚴格比對 `TripCode` 與 `SubmittedBy`。

### 6.3 系統限制
*   **通知延遲**：Email 預通知信可能受 Google Quota 影響，非即時送達。
*   **儲存容量**：`LocalStorage` 容量有限，建議大量照片應儘早同步至雲端。