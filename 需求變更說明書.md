# 員工旅遊費用申請系統 - 需求變更說明書 (RCR)

| 項目 | 內容 |
| :--- | :--- |
| **文件版本** | v2.0 (整合版) |
| **日期** | 2026-01-31 |
| **對象** | 開發團隊 (Frontend/Logic) |

## 目標
實作身分分流、零設定開局、智慧更新與完整重設機制。

---

## 1. 專案背景與變更目標 (Background & Objectives)

### 1.1 現狀痛點 (Pain Points)
*   **進入門檻高**：使用者需手動輸入 GAS URL，容易出錯且體驗不佳。
*   **角色混淆**：單一介面混合了團長（管理）與團員（申報）的功能，導致操作認知負擔。
*   **缺乏錯誤補救**：若輸入錯誤的 TripCode 或旅遊結束，缺乏直覺的「重置/登出」路徑。
*   **狀態不明確**：團員無法直觀看到自己的費用審核狀態（通過/退回）。

### 1.2 變更目標 (To-Be)
*   **零設定開局 (Zero-Config)**：內建預設 API URL，並透過 `config.json` 自動更新，使用者無需手動設定。
*   **身分分流引導 (Role-Based Onboarding)**：首次進入時明確選擇「我是團長」或「我是團員」。
*   **差異化介面**：「旅遊」分頁根據身分顯示不同資訊（團長控管、團員檢視）。
*   **完整生命週期管理**：支援從「建立/加入」到「結案/重設」的完整流程。

---

## 2. 系統架構變更 (System Architecture)

### 2.1 GAS URL 智慧設定與更新
為了達成「零設定」，需改變 API URL 的取得方式。

#### 設定檔 (config.json)
在專案根目錄新增此檔案，用於遠端控制。

```json
{
  "version": "1.0.0",
  "gas_webapp_url": "https://script.google.com/macros/s/CURRENT_DEPLOYMENT_ID/exec",
  "update_message": "系統升級：修復了圖片上傳問題，請更新連線。"
}
```

#### 初始化邏輯 (initApp)
*   **預設值**：程式碼內建 `const DEFAULT_API_URL`。
*   **自動檢查**：App 啟動時背景 fetch `config.json`。
*   **更新提示**：若遠端 URL 與本地不同，彈出 Modal 詢問使用者是否更新。確認後寫入 `localStorage` 並重整。

---

## 3. UI 流程與介面規劃 (UI/UX Design)

### 3.1 初始引導流程 (Onboarding Flow)
當 `localStorage` 無資料時顯示此全螢幕視窗。

#### 按鈕 A：我是團長 (Create Trip)
*   **行為**：自動生成隨機 TripCode (格式：`TRIP-XXXX`)。
*   **資料**：設定 `role: "leader"`。
*   **導向**：直接進入主畫面。

#### 按鈕 B：我是團員 (Join Trip)
*   **行為**：彈出輸入框，要求輸入 TripCode。
*   **資料**：設定 `role: "member"`。
*   **導向**：進入主畫面，並自動觸發一次「下載同步」。

### 3.2 主畫面結構 (Main Layout)
維持 **Top Bar + Content + Bottom Nav (3 Tabs)** 結構。

#### Top Bar (狀態列)
*   **左側**：顯示 TripCode (點擊可複製)。
*   **右側**：同步燈號 (🟢 已同步 / 🟡 未備份 / 🔴 錯誤)。

#### Bottom Nav (導航列)
1.  **記帳 (Home)**
2.  **旅遊 (Trip)** - 核心變更區域
3.  **設定 (Config)**

---

## 4. 詳細功能規劃：依身分分流 (Detailed Features by Role)

### 4.1 分頁二：旅遊 (Trip Tab)
此頁面需根據 `role` 進行 DOM 元素的顯示/隱藏切換。

#### A. 團長視角 (Leader View)
核心任務：控管全團進度、分享代碼、編輯資訊。

**1. 分享區**
*   **TripCode 卡片**：大字體顯示代碼，提供「複製」按鈕。

**2. 旅遊資訊**
*   **編輯按鈕 (✏️)**：點擊後可修改旅遊名稱、起訖日期。

**3. 雲端控制**
*   **主控同步按鈕**：
    *   「☁️ 上傳備份 (Master Upload)」：將全團資料備份至雲端。
    *   「⬇️ 下載更新」：抓取最新狀態。
    *   *(註：若 `isLocked=true`，上傳按鈕需禁用)*

**4. 團員管理**
*   **團員列表**：顯示所有成員，並標示其同步狀態（若 API 支援）。

#### B. 團員視角 (Member View)
核心任務：關注個人權益、查看審核狀態、同步個人資料。

**1. 資訊區**
*   **旅遊資訊 (唯讀)**：僅顯示名稱、日期、目的地圖示，不可編輯。

**2. 雲端控制**
*   **個人同步按鈕**：
    *   「☁️ 上傳我的費用」：僅上傳自己的資料。
    *   「⬇️ 更新進度」：下載團長的審核結果或其他人的資料。
    *   *(註：若有同名衝突或資料落後，顯示紅點提示)*

**3. 狀態儀表**
*   **審核狀態看板** (新增)：顯示三個計數器：
    1.  **進行中 (Pending)**
    2.  **已通過 (Approved)** - 綠色
    3.  **被退回 (Rejected)** - 紅色 (點擊可跳轉首頁並篩選出退回項目)

**4. 團員名單**
*   **簡易列表**：僅列出同行夥伴姓名 (唯讀)。

### 4.2 分頁三：設定 (Config Tab) & 重設機制
此頁面所有身分通用，但需增加「重設」功能以支援流程修正。

#### 個人設定
*   **修改暱稱**：修改 `userName`。

#### 系統設定
*   **檢查更新**：手動觸發 `config.json` 檢查，更新 API URL。
*   **API 設定 (進階顯示)**：預設隱藏 API URL，僅在開啟「開發者模式」或點擊編輯時顯示。

#### 危險操作
*   **離開/重設旅遊 (紅色按鈕)**
    *   **適用情境**：輸入錯代碼、旅遊結束想開新團。
    *   **行為**：
        1.  彈出 confirm 確認視窗。
        2.  清除 `localStorage` (`trip_settings`, `expenses`)。
        3.  `location.reload()` 自動回到初始引導頁。

---

## 5. 操作流程情境 (User Scenarios)

### 情境 A：團員輸入錯誤代碼並修正 (Error Correction)
*   **錯誤操作**：新團員小美在初始畫面選擇「我是團員」，誤輸入代碼 `TRIP-000`。
*   **發現問題**：進入主畫面後，發現「旅遊」分頁資訊空白，或下載不到資料。
*   **修正流程**：
    1.  小美點擊底部 「設定」 分頁。
    2.  滑到最下方，點擊紅色的 「離開/重設旅遊」。
    3.  系統確認後重置，回到初始畫面。
*   **重新加入**：小美再次選擇「我是團員」，輸入正確代碼 `TRIP-8888`，成功看到旅遊資訊。

### 情境 B：團長結案與開啟新團 (Lifecycle Management)
*   **結案**：本次「日本行」結束，團長確認所有費用無誤後，在後台（或未來開發的 App 功能）將狀態設為 Locked。
*   **開啟新團**：
    1.  半年後，公司要去泰國。
    2.  團長打開 App，進入 「設定」 -> 「重設/結束本次旅遊」。
    3.  回到初始頁，選擇 「我是團長」。
    4.  系統生成新的 `TRIP-9999`。
    5.  團長進入 「旅遊」 分頁，編輯名稱為「泰國員工旅遊」。

### 情境 C：團員查看退回案件 (Audit Feedback)
*   **接收通知**：團員阿明聽說費用被退回了。
*   **查看狀態**：
    1.  打開 App，進入 「旅遊」 分頁。
    2.  執行 「⬇️ 更新進度」。
    3.  看到 「審核狀態」 區塊的 「被退回」 顯示數字 1 (紅色)。
*   **處理**：
    1.  阿明回到 「記帳」 首頁。
    2.  列表中的該筆費用顯示紅色邊框/狀態。
    3.  點擊編輯修正後，再次上傳。

### 情境 D：API 自動更新 (Smart Update)
*   **背景**：IT 部門更新了 GAS 後端程式，URL 變更了。
*   **用戶行為**：使用者打開 App。
*   **系統反應**：
    1.  App 偵測到 `config.json` 變更。
    2.  彈窗：「發現新版本連線設定，請更新以確保功能正常。」
*   **結果**：使用者點擊「更新」，App 自動切換至新 URL，無需手動複製貼上。

---

## 6. 資料結構 (Data Schema)

`localStorage` 鍵值 `trip_settings` 需包含以下欄位：

```json
{
  "tripCode": "TRIP-8888",       // 識別碼
  "role": "leader" | "member",   // 身分
  "userName": "王小明",
  "api_url": "https://...",      // 當前使用的 API URL
  "tripName": "日本東京五日遊",
  "startDate": "2026-02-01",
  "endDate": "2026-02-05",
  "isLocked": false,             // 結案鎖定狀態
  "lastSyncTime": 1706660000
}
```
