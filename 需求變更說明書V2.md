# 旅遊記帳 App (v2.0) 需求變更說明書

|項目|內容|
|:---|:---|
|**文件版本**|2.0|
|**日期**|2026-01-31|
|**專案名稱**|Travel Expense App (Group Edition)|

---

## 1. 專案概述與變更目的

原系統為單機備份導向，本次變更旨在轉型為 **「多角色協作的團體記帳系統」**。
核心目標為解決團體旅遊中，團員隱私隔離、團長統籌管理、以及審核人員後端查核的三方協作需求，並大幅優化資料同步與操作體驗。

---

## 2. 角色權限定義 (Role Definitions)

系統需嚴格區分三種角色，並依此調整資料存取權限。

| 角色 | 登入方式 | 權限範圍 | 主要職責 |
| :--- | :--- | :--- | :--- |
| **一般團員 (Member)** | 輸入 `TripCode` + 選擇/輸入姓名 | 僅限本人 (R/W) | 紀錄個人或同行者消費、同步資料。 |
| **團長 (Leader)** | 輸入 `TripCode` + 團長密碼 | 該團所有資料 (R/W) | 管理團員名單、修正團員單據、鎖定並送審。 |
| **審核人員 (Auditor)** | 系統管理密碼 或 Google Sheet 內部選單 | 全系統所有資料 (R/W) | 查核各團單據、匯出報表、系統設定。 |

---

## 3. 功能需求變更詳情

### 3.1 前端 App (PWA) - 團員與互動體驗

#### 3.1.1 登入與身份識別 (New)
*   **TripCode 機制**：使用者初次進入 App 需輸入 `TripCode`。
*   **動態成員名單**：系統呼叫 API 獲取該團成員清單。
    *   **下拉選單**：使用者可直接選擇「我是誰」。
    *   **新增成員**：若名單中無本人，可選擇「我是新成員」並輸入姓名。
*   **自動同步**：新成員送出第一筆資料後，後端自動將其加入該團名單，供團長管理。
*   **同行夥伴綁定**：使用者可設定「常用同行夥伴」（如夫妻、親子），記帳時可快速切換「歸屬人 (BelongTo)」。

#### 3.1.2 資料隱私隔離 (New)
*   **檢視限制**：團員在 App 的列表中，只能看到 `Submitter` (提交人) 或 `BelongTo` (歸屬人) 為自己的單據。
*   **防止窺視**：即使 API 下載了整團資料（為了快取），前端邏輯必須強制過濾顯示內容。

#### 3.1.3 智慧同步與離線機制 (Optimization)
*   **自動偵測更新 (Pull)**：App 啟動或喚醒時，自動檢查 Server 版本。
    *   若有新資料（如團長修正了金額、匯率更新），Header 顯示 **「黃色雲端/更新圖示」**，點擊後執行下載合併。
*   **主動上傳提示 (Push)**：當本地有未上傳資料時，Header 顯示 **「紅色警示點」**。
    *   使用者可隨時點擊上傳，不強制即時同步以節省流量與電力。
*   **狀態視覺化**：標頭需明確顯示「已同步」、「有待上傳資料」、「有新資料可更新」。

### 3.2 團長管理功能 (Leader Features)

#### 3.2.1 團長專屬模式
*   **雙重身分**：團長平時使用 App 記帳（同一般團員介面），但擁有額外權限。
*   **管理入口**：在 App 選單中提供 **「前往團務管理」** 按鈕。
    *   點擊後開啟新視窗/Webview，自動帶入 `URL?tripCode=XXX&role=leader`。
    *   進入管理介面僅需輸入「團長密碼」。

#### 3.2.2 團務管理 (Web Admin)
*   **資料分群管理**：團長可看見該 `TripCode` 下所有人的單據。
    *   介面需清楚區分「團長個人單據」與「團員單據」。
*   **代客修正**：團長可編輯任何團員的單據（修正類別、金額、補照片），系統需記錄「最後修改者」。
*   **案件鎖定與送審**：
    *   提供 **「鎖定/解鎖」** 功能。鎖定後，團員 App 端不可再編輯，僅能瀏覽。
    *   提供 **「送出審核」** 按鈕，狀態變更為 `Submitted`，此時審核人員才需介入處理。

### 3.3 後台管理系統 (Admin Portal & Google Sheet)

#### 3.3.1 雙模組登入
*   **Web 模式**：透過網頁登入，需輸入 GAS Web App URL（由系統自動注入，無需手動複製）及系統密碼。
*   **Sheet 內嵌模式 (Google Sheet Menu) (New)**：
    *   在 Google Spreadsheet 的選單列新增 **「旅遊記帳管理」** 選單。
    *   點擊後在右側 Sidebar 或彈出視窗直接顯示管理介面。
    *   **免登入優勢**：利用 Google 帳號權限直接驗證，審核人員無需記憶額外密碼。

#### 3.3.2 資料檢視與操作優化
*   **權限視野**：審核人員預設過濾出 `Status = Submitted` (已送審) 的團體資料。
*   **進階列表控制**：
    *   **排序 (Sort)**：依日期、金額、提交人排序。
    *   **篩選 (Filter)**：依「團員姓名」、「消費類別」、「審核狀態」篩選顯示。
*   **圖片檢視優化 (Lightbox)**：
    *   點擊單據縮圖，開啟全螢幕檢視模式。
    *   支援縮放 (Zoom) 與平移 (Pan)，以便查核單據細節（如模糊的金額、品項）。

#### 3.3.3 自動化部署設定
*   **免設定 URL**：部署腳本或 HTML Template 需透過 `ScriptApp.getService().getUrl()` 自動注入 API 網址至前端 config 中，消除人工複製 URL 的步驟。

---

## 4. 資料庫結構變更 (Google Sheets Schema)

### 4.1 新增 Trips 分頁 (團務設定)

| 欄位名稱 | 說明 | 範例 |
| :--- | :--- | :--- |
| **TripCode (Key)** | 團體唯一代碼 | `2024-JP-Spring` |
| **TripName** | 團體顯示名稱 | `2024 日本春季賞櫻團` |
| **Password** | 團長登入密碼 | `jp888` |
| **LeaderName** | 團長姓名 | `Alex` |
| **Members** | 成員名單 (JSON/CSV) | `Alex, Bob, Carol` (系統自動維護) |
| **Status** | 團務狀態 | `Open` (進行中), `Submitted` (已送審), `Closed` (結案) |

### 4.2 修改 Expenses 分頁 (消費紀錄)

*   **新增 TripCode**：關聯至 Trips 表，用於區分不同團體資料。
*   **新增 BelongTo**：消費歸屬人。預設與 `Submitter` 相同，但可由提交人或團長修改（例如：團長幫團員付錢，`Submitter`=團長, `BelongTo`=團員）。

---

## 5. 非功能性需求

*   **相容性**：確保 iOS/Android 手機瀏覽器 (Safari/Chrome) 對 PWA 功能（安裝、Service Worker）的支援。
*   **效能**：圖片上傳前需在前端進行壓縮，減少 GAS 傳輸負載與 Sheet 儲存空間。
*   **安全性**：API 需驗證 Token 或 `TripCode/Password` 組合，防止未經授權的跨團資料存取。